---
title: "Aim 1 Analysis Code"
author: "Courtney Victor"
date: "started 05 February 2024; most recent edits `r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 4
    toc_float: true
    number_sections: true
    code_folding: hide
    theme: cosmo
    keep_md: true
  md_document:
    variant: markdown_github

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

**Aim 1**: to test how the provision of an improved piped water network impacts water access and quality. 

*Hypotheses*: I predict that a) individuals who live in neighborhoods with the improved piped water network and b) individuals who have a household connection to an improved water supply will have improved cwater quality and access compared to individuals who do not live in such a) neighborhoods or b) households.

The data for this analysis comes from the PAASIM “Pesquisa sobre o Acesso à Água e a Saúde Infantil em Moçambique” (PAASIM- Research on Access to Water and Child Health in Mozambique). The purpose of this project is to evaluate the impact of a new piped water network among informal settlements in the city of Beira using a matched control study design. A detailed description of the study protocol can be found here: https://bmjopen.bmj.com/content/13/3/e067341. The pre-specified analysis plan can be found here: https://osf.io/4rkn6/. 

```{r packages, message = F, results = F, warning = F}
# CREATE PACKAGE LIST:
Packages <- c("tidyverse", "knitr", "kableExtra", "readxl", "evaluate") 

# LOAD PACKAGES:
lapply(Packages, library, character.only = TRUE)

# SUPPRESS UNHELPFUL `dplyr` MESSAGES: 
options(dplyr.summarise.inform = FALSE)

```

**Packages used:**

`r Packages`

# Data

### Exposure
In brief, our intervention will be defined in two ways: 
* (1) People living in neighborhoods with the improved piped water network and 
* (2) individuals who have a household connection to an improved water supply. 

![**Figure 1.** Intervention Definitions](Figure 1_Intervention Definitions.png)

### Outcome 
We have water quality and access data from 548 households x 5 timepoints. Water quality will be defined by presence of *E. coli* (primary outcome), total coliforms, free and total chlorine, pressure, and enteropathogen data (from a subset of 100 households). We also have survey data that includes questions on satisfaction with water pressure, service, availability, and quality. Water access will be defined by the HWISE score, more information can be found here: https://www.ipr.northwestern.edu/wise-scales/measure-water-insecurity/. 

```{r data import, warning = FALSE}
# Remove the `Packages` variable from your environment
rm(Packages)

data <- read_excel("../../../../../../OneDrive-SharedLibraries-EmoryUniversity/Levy, Karen - 1. PAASIM/3. Data and Analysis/Data/Blinded dataset/Cleaned/PAASIM full cleaned data.xlsx")

# # doing some simple data exploration
# head(data)
# str(data)
# View(data)

```

## Data Formatting

I filtered the master dataset to only the variables that will be used in this analysis. I rename variables to assist with downstream analysis. I also include code for creating a fake intervention arm/variable to use in the analysis. When we are ready to unblind, I will delete this text and the code for the false intervention variable and will update the input data file to the unblinded dataset. 

```{r data formatting}
# Create new dataset with variables used in this analysis
data_filt <- data %>%
  select(main_id, visit, neighborhood, code, SES_score, high_poverty, san_basic_obs, fixed_emp_pri, secondary_complete, num_lt5, num_HH, months_in_hh, human_feces, animal_feces, HFIAS_score, HFIA_category, HW_dwell, season_rainy, flooding_HH_yard, ecolimpn_source, ecolimpn_stored, coliformmpn_source, coliformmpn_stored, C_10, water_service_ladder, improved_water, C_21, C_22, C_17, C_20, C_19, C_28_A1, C_28_A2, A_W_9, JMP_H2, C_4, C_23, C_18, O_W_7, O_W_8, C_12, LT30min, timeperweek, flow_rate, C_24, C_25, HWISE_scale, HWISE_insecure, M_1B, C_15_D, C_31, sub_SES_score, sub_density, sub_SES_tertile, sub_density_tertile, sub_density_strata) %>%
  rename(water_source = C_10, sat_color_appear = C_21, sat_taste_smell = C_22, sat_service = C_17, sat_pressure = C_20, sat_avail = C_19, storage_tank = C_28_A1, water_storage = A_W_9, water_HW = JMP_H2, share_FIPAG = C_4, sufficient_quant = C_23, sat_afford = C_18, free_chlor = O_W_7, total_chlor = O_W_8, collect_contin = C_12, avail_hr = C_24, avail_day = C_25, use_meter = M_1B, use_respond = C_15_D, child_consump = C_31)

# Create false intervention variable (will be deleted after unblinding)


# cleanup
# (always clean up after yourself)

```

# Analysis

I briefly describe an outline of the planned analyses below. First, I will import and filter the data for variables that will be used in this analysis. I will univariately explore the associations between both levels of our intervention (household and neighborhood) and water quality and access. Following this, I will construct multivariate generalized estimating equations (GEE) to look at the association between both levels of the intervention and various water quality and access variables. 

* Table 1: Baseline differences in covariates of interest (neighborhood-level)
* Table 2: Baseline differences in covariates of interest (household-level)
* Table 3: Univariate analysis of water quality and access (neighborhood-level)
* Table 4: Univariate analysis of water quality and access (household-level)
* Table 5: Multivariate modeling of neighborhood-level intervention status and water quality and access 
* Figure 2: Plots associated with data from Table 5
* Table 6: Multivariate modeling of household-level intervention status and water quality and access 
* Figure 3: Plots associated with data from Table 6


## Data overview

In this context, I think it is helpful to put **in-line code** into the **text** section of the report (i.e., not in a chunk) so that the results can be, well, contextualized. For example, we could report on the mean sepal width in the `iris` dataframe that is included with R:

* mean sepal width in the `iris` dataframe: `r mean(iris$Sepal.Width)`

Sometimes it makes sense to include a code chunk (i.e., not just inline code) here, if needed to make more complex calculations; anything more than a couple of operations is typically best left to a code chunk, and can then be reported on in the text below the code chunk. The chunk below includes code from Loy et al.'s accelerated snowmelt and seed production analysis; the lines of codes included outside of the chunk (in the default Rmarkdown text) are repeated within the chunk (but commented out and thus not evaluated in the chunk). While this is by definition repetitive, it makes it easy for a reader of the Rmarkdown report to see how the calculations were conducted, without having to separately open the .Rmd file.

```{r data overview, eval = F}

# FIRST THING if altering: CHANGE CODE CHUNK HEADER TO REMOVE `eval = F`!

# this code is just an example of one way this could be done; change to best suit the purposes of your project.

# most of this is displayed in text below the code chunk

# Number of plants
# * `r nrow(masterdat)` plants

# Number of plants per treatment
plants.per.treat = masterdat %>% group_by(plot.treat) %>%
  summarise(no_rows = length(plot.treat))
    # + `r as.numeric(plants.per.treat[2,2])` plants in control plots
    # + `r as.numeric(plants.per.treat[1,2])` plants in snowmelt-accelerated plots

# Total number of seeds
# * `r as.integer(sum(masterdat$totalseeds))` total seeds
# "as.integer" makes it so that it does not display in scientific notation

```

## Table 1 - Baseline differences in covariates of interest (neighborhood-level)

```{r table 1}

# Formatting

# Data Analysis

# Cleanup
# rm(insert removable objects here)

```

## Table 2 - Baseline differences in covariates of interest (household-level)

```{r}
# Formatting

# Data Analysis

# Cleanup
# rm(insert removable objects here)
```

## Table 3 - Univariate association between intervention with water quality and access  (neighborhood-level)
```{r}
# Formatting

# Data Analysis 

# Cleanup
# rm(insert removable objects here)
```

## Table 4 - Univariate association between intervention with water quality and access (household-level)
```{r}
# Formatting

# Data Analysis 

# Cleanup
# rm(insert removable objects here)
```

## Table 5 - Multivariate association between intervention with water quality and access (neighborhood-level)

### Model Construction (Table 5)
```{r model construction table 5}

```

### Model Validation (Table 5)

```{r model validation table 5}

# (for GLMMs, we typically use the `DHARMa` package for this, e.g.
# replace "my.model" with the name of the model you are assessing
# and probably change the name "sim.out.my.model" to something more descriptive)
# simulate residuals using DHARMa:
sim.out.my.model <- simulateResiduals(fittedModel = my.model, plot = F)
plot(sim.out.my.model) # plot residual plots
testDispersion(sim.out.my.model, plot = F) # print dispersion results
testZeroInflation(sim.out.my.model, plot = F) # print zero-inflation results

# CLEANUP
# again, remove anything that isn't subsequently used in the analysis
rm(sim.out.my.model)

```

### Plots (Table 5) 
```{r plot table 5}

# any data preparation / summarization needed for plotting
# code below is just a placeholder!
myplotdata = mydata %>% group_by(mygroupingvar1, mygroupingvar1) %>% 
  summarize(mean = mean(), stdev = sd()...) 

# create the actual plot (almost always using `ggplot2`)
myplot = ggplot(myplotdata, ...)

# DISPLAY the plot in your Rmarkdown report 
# (usually just a single line of code, 
# the name of the ggplot object you created above)
myplot

# SAVE PLOT
# example, but key thing is the `plots/` prefix in the file path
ggsave(myplot, file = "plots/myplot.pdf", width = 5, height = 3)

# # CLEANUP
# # remember to also clean up any objects such as data summarizations
# # set up for your plotting, e.g.:
rm(myplotdata, myplot)

```

## Table 6 - Multivariate association between intervention with water quality and access (household-level)

### Model Construction (Table 6)
```{r model construction table 6}

```

### Model Validation (Table 6)

```{r model validation table 6}

# (for GLMMs, we typically use the `DHARMa` package for this, e.g.
# replace "my.model" with the name of the model you are assessing
# and probably change the name "sim.out.my.model" to something more descriptive)
# simulate residuals using DHARMa:
sim.out.my.model <- simulateResiduals(fittedModel = my.model, plot = F)
plot(sim.out.my.model) # plot residual plots
testDispersion(sim.out.my.model, plot = F) # print dispersion results
testZeroInflation(sim.out.my.model, plot = F) # print zero-inflation results

# CLEANUP
# again, remove anything that isn't subsequently used in the analysis
rm(sim.out.my.model)

```

### Plots (Table 6) 
```{r plot table 6}

# any data preparation / summarization needed for plotting
# code below is just a placeholder!
myplotdata = mydata %>% group_by(mygroupingvar1, mygroupingvar1) %>% 
  summarize(mean = mean(), stdev = sd()...) 

# create the actual plot (almost always using `ggplot2`)
myplot = ggplot(myplotdata, ...)

# DISPLAY the plot in your Rmarkdown report 
# (usually just a single line of code, 
# the name of the ggplot object you created above)
myplot

# SAVE PLOT
# example, but key thing is the `plots/` prefix in the file path
ggsave(myplot, file = "plots/myplot.pdf", width = 5, height = 3)

# # CLEANUP
# # remember to also clean up any objects such as data summarizations
# # set up for your plotting, e.g.:
rm(myplotdata, myplot)

```

# Session Info

```{r Session Info}
sessionInfo()
```

