---
title: "Aim 1 Analysis Code"
author: "Courtney Victor"
date: "Started 05 February 2024; Most recent edits `r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 4
    toc_float: true
    number_sections: true
    code_folding: hide
    theme: cosmo
    keep_md: true
  md_document:
    variant: markdown_github

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#rm(list = ls())

# Define the function to create frequency tables for binary variables
frequency_table <- function(data, var, group_var) {
  data %>%
    filter(!is.na(!!sym(var))) %>%
    group_by(!!sym(group_var), !!sym(var)) %>%
    summarise(count = n(), .groups = "drop") %>%
    group_by(!!sym(group_var)) %>%
    mutate(denominator = sum(count),
           percentage = count / denominator * 100) %>%
    ungroup() %>%
    mutate(variable = var) %>% # Add the variable name as a column
    select(variable, !!sym(group_var), variable_value = !!sym(var), count, percentage)
}

# Define the function to create frequency tables to loop over multiple variables
frequency_tables_for_vars <- function(data, vars, group_var) {
  result_list <- lapply(vars, function(var) {
    frequency_table(data, var, group_var)
  })
  names(result_list) <- vars
  result_list
}

# Frequency table for continuous variables
summary_statistics <- function(data, var, group_var) {
  data %>%
    filter(!is.na(!!sym(var))) %>% # Remove rows with missing values in the variable
    group_by(!!sym(group_var)) %>%
    summarise(
      mean = mean(!!sym(var), na.rm = TRUE),
      sd = sd(!!sym(var), na.rm = TRUE),
      median = median(!!sym(var), na.rm = TRUE),
      IQR = IQR(!!sym(var), na.rm = TRUE),
      .groups = 'drop'
    ) %>%
    mutate(variable = var) %>% # Add the variable name to each data frame
    select(variable, !!sym(group_var), mean, sd, median, IQR) # Arrange columns
}

## Define a function to loop over a list of continuous variables
summary_statistics_for_vars <- function(data, vars, group_var) {
  result_list <- lapply(vars, function(var) {
    df <- summary_statistics(data, var, group_var)
    return(df)
  })
  return(result_list)
  
}

# Write functions for GEE models
## Log binomial
extract_summary <- function(model_formula, outcome_var_name, data) {
  library(gee)
  
  # Fit GEE model
  model <- gee(model_formula, id = code, data = data, family = binomial(link = "log"), corst = "independence")
  
  # Extract model summary
  model_summary <- summary(model)
  
  # Get the index of the 'arm' predictor in the model formula
  arm_index <- which(names(model$coefficients) == "arm")
  
  # Extract robust standard error for 'arm'
  robust_se_arm <- sqrt(model$robust.variance[arm_index, arm_index])
  
  # Extract coefficients and compute Prevalence ratio, p-value, and confidence interval
coef <- model_summary$coefficients[2, 1]
p_value <- 2 * (1-pnorm(abs(model_summary$coefficients[2, 5]))) # Calculated based on robust z
robust_se <- abs(model_summary$coefficients[2, 4]) # Standard error from robust z
ci_lower <- exp(coef - 1.96 * robust_se)
ci_upper <- exp(coef + 1.96 * robust_se)
prevalence_ratio <- exp(coef)
  
  # Create a dataframe for the result
  result_df <- data.frame(
    Outcome_Variable = outcome_var_name,
    Prevalence_Ratio = prevalence_ratio,
    P_Value = p_value,
    CI_Lower = ci_lower,
    CI_Upper = ci_upper,
    Robust_se = robust_se
  )
  
  # Return a list containing both the result dataframe and the model summary object
  return(list(result_df = result_df, model_summary = model_summary))
}


## Modified Poisson
# Write function to extract PR, p-value, CI from similar models- modified Poisson for models that did not converge with log binomial
extract_summary_pois <- function(model_formula, outcome_var_name, data) {
  library(gee)
  
  # Fit GEE model
  model <- gee(model_formula, id = code, data = data, family = poisson(link = "log"), corst = "independence")
  
  # Extract model summary
  model_summary <- summary(model)
  
  # Get the index of the 'arm' predictor in the model formula
  arm_index <- which(names(model$coefficients) == "arm")
  
  # Extract robust standard error for 'arm'
  robust_se_arm <- sqrt(model$robust.variance[arm_index, arm_index])
  
  # Extract coefficients and compute prevalence ratio, p-value, and confidence interval
coef <- model_summary$coefficients[2, 1]
p_value <- 2 * (1-pnorm(abs(model_summary$coefficients[2, 5]))) # Calculated based on robust z
robust_se <- abs(model_summary$coefficients[2, 4]) # Standard error from robust z
ci_lower <- exp(coef - 1.96 * robust_se)
ci_upper <- exp(coef + 1.96 * robust_se)
prevalence_ratio <- exp(coef)
  
  # Create a dataframe for the result
  result_df <- data.frame(
    Outcome_Variable = outcome_var_name,
    Prevalence_Ratio = prevalence_ratio,
    P_Value = p_value,
    CI_Lower = ci_lower,
    CI_Upper = ci_upper,
    Robust_se = robust_se
  )
  
  # Return a list containing both the result dataframe and the model summary object
  return(list(result_df = result_df, model_summary = model_summary))
  
}

```

# Introduction

**Aim 1**: to test how the provision of an improved piped water network impacts water access and quality. 

*Hypotheses*: I predict that a) individuals who live in neighborhoods with the improved piped water network and b) individuals who have a household connection to an improved water supply will have improved cwater quality and access compared to individuals who do not live in such a) neighborhoods or b) households.

The data for this analysis comes from the PAASIM “Pesquisa sobre o Acesso à Água e a Saúde Infantil em Moçambique” (PAASIM- Research on Access to Water and Child Health in Mozambique). The purpose of this project is to evaluate the impact of a new piped water network among informal settlements in the city of Beira using a matched control study design. A detailed description of the study protocol can be found here: https://bmjopen.bmj.com/content/13/3/e067341. The pre-specified analysis plan can be found here: https://osf.io/4rkn6/. 

```{r packages, message = F, results = F, warning = F}
# Create package list
Packages <- c("tidyverse", "knitr", "kableExtra", "readxl", "evaluate", "boot", "table1", "broom", "flextable", "gee", "purrr", "glmtoolbox", "MatchIt", "gridExtra", "ggcorrplot", "lme4", "performance", "RColorBrewer") 

# Load packages
lapply(Packages, library, character.only = TRUE)

# Suppress dplyr messages
options(dplyr.summarise.inform = FALSE)

```

**Packages used:**

`r Packages`

# Data

### Exposure
In brief, our intervention will be defined in two ways: 
* (1) People living in neighborhoods with the improved piped water network (Intervention) and 
* (2) individuals who have a household (HH) connection to an improved water supply (direct connection). 

![**Figure 1.** Intervention Definitions](Figure 1_Intervention Definitions.png)

### Outcome 
We have water quality and access data from 548 households x 5 timepoints. Water quality will be defined by presence of *E. coli* in source (primary outcome) and stored water, free chlorine, and pressure. We also have survey data that includes questions on water access, water usage, water source, and satisfaction with water pressure, service, availability, and quality. Water access will be defined by the HWISE score, more information can be found here: https://www.ipr.northwestern.edu/wise-scales/measure-water-insecurity/. 

We first analyze all exposure/outcome relationships at the 12-month timepoint and follow this analysis with an analysis across all timepoints.

```{r data import, warning = FALSE}
# Read in data
data <- read_csv("../../../../../../OneDrive-SharedLibraries-Emory/Levy, Karen - 1. PAASIM/3. Data and Analysis/Data/Blinded dataset/Cleaned/PAASIM full cleaned data.csv")

```

## Data Formatting

I filter the master dataset to only the variables that will be used in this analysis and only to visits from households that have completed the study (study_complete). I rename variables to assist with downstream analysis. I also merge the intervention arm and matching data. 

I use visit = 1 to create all baseline variables. I dropped visit = 0 as these were only if the mother wasn't 31 weeks pregnant. These data were just used to plan future enrollment visits. 

```{r data formatting, results = 'hide'}
# Create smaller dataset with variables used in this analysis
data_filt <- data %>%
  dplyr::filter(study_complete == 1 & visit != 0) %>%
  dplyr::select(main_id, visit, neighborhood, code, SES_score_bl, high_poverty, san_basic_obs_bl, fixed_emp_pri, secondary_complete_bl, num_lt5, num_HH, months_in_hh, human_feces, animal_feces, HFIAS_score, HFIA_category, HW_dwell, season_rainy, flooding_HH_yard, ecolimpn_source, ecolimpn_stored, coliformmpn_source, coliformmpn_stored, C_10, water_service_ladder, improved_water, C_21, C_22, C_17, C_20, C_19, C_28_A1, C_28_A2, A_W_9, JMP_H2, C_4, C_23, C_18, O_W_7, O_W_8, C_12, LT30min, timeperweek, flow_rate, C_24, C_25, HWISE_insecure_new, M_1B, C_15_D, C_31, sub_SES_score, sub_density, sub_SES_tertile, sub_density_tertile, sub_density_strata, SES_score_bl, ecoli_bin_source, ecoli_bin_stored, basic_water, onpremises, sufficient, C_17_bin, C_18_bin, C_19_bin, C_20_bin, C_21_bin, C_22_bin, C_1, C_2, ecolimpn_source_cat, ecolimpn_stored_cat, san_basic_obs_bl, D_1, D_2, D_3, D_4, D_5, D_6, D_7, D_8, D_9, D_10, D_11, D_12, hh_date, C_24,crossover, free_chlor_WHO) %>%
  rename(water_source = C_10, sat_color_appear = C_21, sat_taste_smell = C_22, sat_service = C_17, sat_pressure = C_20, sat_avail = C_19, storage_tank = C_28_A1, water_storage = A_W_9, water_HW = JMP_H2, share_FIPAG = C_4, sufficient_quant = C_23, sat_afford = C_18, free_chlor = O_W_7, total_chlor = O_W_8, collect_contin = C_12, avail_hr = C_24, avail_day = C_25, use_meter = M_1B, use_respond = C_15_D, child_consump = C_31, always_sat_service = C_17_bin, always_sat_afford = C_18_bin, always_sat_avail = C_19_bin, always_sat_pressure = C_20_bin, always_sat_appear = C_21_bin, always_sat_taste = C_22_bin)

# Add in intervention variable- saved locally for blinding purposes.
matching_arm <- read_excel("/Users/cmpoulo/Desktop/matching_arm.xlsx")

## Merge with large data set by sub-neighborhood 'code' ID
all_data <- merge(matching_arm, data_filt, by = "code", all = TRUE)

# Create direct connection variable (an active FIPAG HH connection)
all_data$hh_water <- ifelse(all_data$C_1 == 1 & (all_data$C_2 == 1 | all_data$C_2 == 2), 1, 0)

# Categorizing 'use_respond' variable (participant reported water use in liters per day)
## Get summary
summary(all_data$use_respond)

## categorize by median value of 80 L/day (non-normally distributed)
all_data <- all_data %>%
  mutate(use_respond_bin = ifelse(use_respond >= 80, 1, 0))

# Clean up 
rm(data_filt, data, matching_arm, Packages)
```

# Impact of the intervention and association with direct connection on water quality and access

I briefly describe an outline of the planned analyses below. Our pre-analysis plan with further details can be found at: https://osf.io/4rkn6/

* Supplemental Figure 2: Correlation between outcome variables 
* Table 1a: Baseline differences in covariates of interest by intervention status (Table 1 in manuscript)
* Table 1b: Baseline differences in covariates of interest by direct HH connection status (Table 1 in manuscript)
* Figure 2: Source E.coli categories at 12-months by intervention status (intervention and direct HH connection)
* Supplemental Table 2: Impact of intervention on water quality and access (12-months)
* Table 2. Impact of the intervention on water quality and access variables (all timepoints)
* Supplemental Table 3: Association between direct HH connection and water quality and access variables (12-months)
* Table 3: Association between having a direct connection and water quality and access variables (all timepoints) 
* Supplemental Table 4: Characteristics of study participants stratified by combined intervention status
* Supplemental table 5: Evaluation of interaction between intervention and direct HH connection status on water quality and access variables 
* Figure 3: Plot model results from table 2b and supplemental table 5


## Supplemental Figure 1: Frequency and correlation tables for outcomes of interest 
```{r freq table formatting and correlation plot}
# Outcome list 
## Make sure all variables are correctly classified as character for the frequency tables
character_vars <- c("arm", "final_match_strata_3", "san_basic_obs_bl", "secondary_complete_bl", "ecoli_bin_source", "ecoli_bin_stored", "basic_water", "onpremises", "sufficient", "HWISE_insecure_new", "always_sat_service", "always_sat_afford", "always_sat_avail", "always_sat_pressure", "always_sat_appear", "always_sat_taste", "use_respond_bin", "hh_water", "free_chlor_WHO")

all_data_freq <- all_data %>%
  dplyr::mutate(across(all_of(character_vars), as.character))

# Create correlation tables 
## Make sure all variables are classified as numeric for the correlation plot 
numeric_vars <- c("ecoli_bin_source", "ecoli_bin_stored", "basic_water", "onpremises", "sufficient", "HWISE_insecure_new", "always_sat_service", "always_sat_afford", "always_sat_avail", "always_sat_pressure", "always_sat_appear", "always_sat_taste", "use_respond_bin", "free_chlor_WHO")
## Make all variables numeric
all_data_num <- all_data %>%
  dplyr::mutate(across(all_of(numeric_vars), as.numeric))

phi_matrix <- cor(all_data_num[numeric_vars], use = "complete.obs")

# Format row and column names for correlation plot
colnames(phi_matrix) <- c("E. coli in source water", "E. coli in stored water", "Access to basic water", "Access to water on the premises", "Access to sufficient quantities of water", "Water insecure", "Satisfied with service", "Satisfied with affordability", "Satisfied with availability", "Satisfied with pressure", "Satisfied with color and appearance", "Satisfied with taste and smell", ">= 80 L/day water use", "Free chlorine in source water")
rownames(phi_matrix) <- c("E. coli in source water", "E. coli in stored water", "Access to basic water", "Access to water on the premises", "Access to sufficient quantities of water", "Water insecure", "Satisfied with service", "Satisfied with affordability", "Satisfied with availability", "Satisfied with pressure", "Satisfied with color and appearance", "Satisfied with taste and smell", ">= 80 L/day water use", "Free chlorine in source water")

# Create correlation plot 
outcome_correlations <- ggcorrplot(phi_matrix, 
           type = "upper",         
           lab = TRUE,            
           lab_size = 3.5,      
           colors = c("#E46726","white", "#6D9EC1"), 
           legend.title = NULL,
           title = "Outcome Phi Correlation Matrix",       
           ggtheme = ggplot2::theme_gray + 
             theme(
               axis.text.x = element_text(size = 6),   # Adjust font size for x-axis labels
               axis.text.y = element_text(size = 6)    # Adjust font size for y-axis labels
             ))

outcome_correlations <- outcome_correlations +
theme(
    axis.text.x = element_text(size = 10),   # Adjust font size for x-axis labels
    axis.text.y = element_text(size = 10),   # Adjust font size for y-axis labels
    plot.title = element_text(size = 12)    # Adjust font size for plot title
  )

outcome_correlations

# Save plot
ggsave("plots/Supplemental Figure 1. Correlation between outcome variables.png", outcome_correlations, height = 7, width = 10)

# Cleanup
rm(phi_matrix, all_data_num, outcome_correlations, numeric_vars)
```

## Outcome frequency data for table 2 and supplemental table 2 (intervention)
```{r frequency table network}
# Filter out crossover households (only for intervention analysis)
all_data_network <- all_data %>%
  filter(crossover == 0)

# Create list of outcome variables
variables <- c("ecoli_bin_source", "ecoli_bin_stored", "basic_water", "onpremises", "sufficient", "HWISE_insecure_new", "always_sat_service", "always_sat_afford", "always_sat_avail", "always_sat_pressure", "always_sat_appear", "always_sat_taste", "use_respond_bin", "free_chlor_WHO")

# Frequency table for intervention (all timepoints)
result_list <- frequency_tables_for_vars(all_data_network, variables, "arm")
combined_results <- bind_rows(result_list)

table2_freq <- combined_results %>%
  filter(variable_value == 1)

# Frequency table at visit 5 (12-months) only 
network_visit5 <- all_data_network %>%
  filter(visit == 5)

result_list <- frequency_tables_for_vars(network_visit5, variables, "arm")
combined_results <- bind_rows(result_list)

supp_table2_freq <- combined_results %>%
  filter(variable_value == 1)

```

```{r intervention outcome frequency table, echo = FALSE}
knitr::kable(supp_table2_freq, caption = "Frequency outcome data for supplemental table 2 (intervention at 12-months)")
knitr::kable(table2_freq, caption = "Frequency outcome data for table 2 (intervention across all timepoints)")
```


## Outcome frequency data for supplemental table 3 and table 3 (direct connection)
```{r household table}
# Remove NA values for hh_water but keep crossover households
all_data_freq <- all_data %>%
  filter(!is.na(hh_water))

result_list <- frequency_tables_for_vars(all_data_freq, variables, "hh_water")
combined_results <- bind_rows(result_list)

table3_freq <- combined_results %>%
  filter(variable_value == 1)

# Frequency table at visit 5 only 
all_data_freq_visit5 <- all_data_freq %>%
  filter(visit == 5)

result_list <- frequency_tables_for_vars(all_data_freq_visit5, variables, "hh_water")
combined_results <- bind_rows(result_list)

supp_table3_freq <- combined_results %>%
  filter(variable_value == 1)

# Cleanup
rm(all_data_freq, all_data_freq_visit5, combined_results, result_list, variables)
```

## Table 1a -  Differences in covariates of interest at enrollment (intervention)
```{r table 1a}
# Formatting
## Filter to enrollment timepoint
data_visit1 <- all_data %>%
  filter(visit == 1)

## filter out crossover households
data_visit1_network <- data_visit1 %>%
  filter(crossover== 0)

# Make variable lists
variables <- c("secondary_complete_bl", "san_basic_obs_bl", "fixed_emp_pri", "human_feces", "animal_feces", "HW_dwell", "season_rainy", "flooding_HH_yard", "high_poverty")

continuous_variables <- c("num_lt5", "num_HH", "months_in_hh", "HFIAS_score", "avail_hr")

# Network enrollment table for binary vars
result_list <- frequency_tables_for_vars(data_visit1_network, variables, "arm")
combined_results <- bind_rows(result_list)

table1a <- combined_results %>%
  filter(variable_value == 1)

# Repeat for continuous variables 
result_list_continuous <- summary_statistics_for_vars(data_visit1_network, continuous_variables, "arm")
table1a_continuous <- bind_rows(result_list_continuous)

# Save tables
write.csv(table1a, "results/Table 1a. Differences in covariates of interest at enrollment by intervention status (binary).csv")
write.csv(table1a_continuous, "results/Table 1a. Differences in covariates of interest at enrollment by intervention status (continuous).csv")

```

Based on the table above, we need to control for months living in household and fixed employment of primary caregiver in addition to pre-specified covariates (high poverty, san_basic_obs_bl, secondary_complete_bl). 

## Table 1b - Baseline differences in covariates of interest (direct connection)
```{r table 1b}
# HH enrollment table for factor vars
result_list <- frequency_tables_for_vars(data_visit1, variables, "hh_water")
combined_results <- bind_rows(result_list)

table1b <- combined_results %>%
  filter(variable_value == 1)

# Repeat for continuous variables 
result_list_continuous <- summary_statistics_for_vars(data_visit1, continuous_variables, "hh_water")
table1b_continuous <- bind_rows(result_list_continuous)

# Save tables
write.csv(table1b, "results/Table 1b. Differences in covariates of interest at enrollment by direct HH connection status (binary).csv")
write.csv(table1b_continuous, "results/Table 1b. Differences in covariates of interest at enrollment by direct HH connection status (continuous).csv")

# Cleanup
rm(combined_results, data_visit1, data_visit1_network, result_list, result_list_continuous, continuous_variables, variables)
```

For Direct connection effect models, I need to control for months living in HH, fixed employment of primary wage earner, and any flooding in HH or yard in the past month in addition to pre-specified covariates. We will not control for HW station in dwelling or yard with soap and water because this is likely downstream from the exposure. 

## Figure 2. Source E.coli prevalence categories by intervention status at 12-months (intervention and direct connection)
```{r figure3}
# Figure 2 Panel A (Intervention)
all_data_figure2 <- all_data %>%
  filter(visit == 5)

## remove NA values
all_data_figure2 <- all_data_figure2[!is.na(all_data_figure2$ecolimpn_source_cat), ]

all_data_figure2 <- all_data_figure2 %>%
  mutate(arm = factor(arm, labels = c("Control", "Intervention")))

all_data_figure2$ecolimpn_source_cat <- factor(all_data_figure2$ecolimpn_source_cat, 
                                               labels = c("<1", "1-9", "10-99", "100-999", ">1000"),
                                               levels = c("-1", "0", "1", "2", "3"))

# Remove crossover households from the intervention panel
all_data_figure2_network <- all_data_figure2 %>%
  filter(crossover == 0)

all_data_figure2_network <- all_data_figure2_network %>%
  group_by(arm, ecolimpn_source_cat) %>%
  summarise(count = n()) %>%
  mutate(percent = count / sum(count) * 100) 


all_data_figure2_network <- all_data_figure2_network %>%
  mutate(label = case_when(
    arm == "Intervention" & ecolimpn_source_cat == "<1" ~ "+6.48",
    arm == "Intervention" & ecolimpn_source_cat == "1-9" ~ "-1.28",
    arm == "Intervention" & ecolimpn_source_cat == "10-99" ~ "-5.02",
    arm == "Intervention" & ecolimpn_source_cat == "100-999" ~ "-0.84",
    arm == "Intervention" & ecolimpn_source_cat == ">1000" ~ "+0.67",
    TRUE ~ NA_character_
  ))

figure2a <- ggplot(all_data_figure2_network, aes(x = ecolimpn_source_cat, y = percent, fill = arm)) +
  geom_bar(position = "dodge", stat = "identity") +
  labs(
    title = "A",
    x = expression(italic(E.~coli)~contamination~levels~`in`~source~water~(MPN/`100`~mL)),
    y = "Percent Frequency",
    fill = "Intervention"
  ) +
  theme_minimal() +
  geom_text(aes(label = label), position = position_dodge(width = 0.9), vjust = -0.5) +
 theme(
    plot.title = element_text(size = 20),        # Adjust the plot title size
    axis.title.x = element_text(size = 13),      # Adjust the x-axis title size
    axis.title.y = element_text(size = 16),      # Adjust the y-axis title size
    axis.text.x = element_text(size = 12),       # Adjust the x-axis text size
    axis.text.y = element_text(size = 12),       # Adjust the y-axis text size
    legend.title = element_text(size = 16),      # Adjust the legend title size
    legend.text = element_text(size = 14)        # Adjust the legend text size
  )


# Figure 2 Panel B
all_data_figure2 <- all_data %>%
  filter(visit == 5)

all_data_figure2 <- all_data_figure2 %>%
  filter(!is.na(ecolimpn_source_cat) & !is.na(hh_water))

all_data_figure2 <- all_data_figure2 %>%
  mutate(hh_water = factor(hh_water, labels = c("No access", "Access")))

all_data_figure2$ecolimpn_source_cat <- factor(all_data_figure2$ecolimpn_source_cat, 
                                               labels = c("<1", "1-9", "10-99", "100-999", ">1000"),
                                               levels = c("-1", "0", "1", "2", "3"))

all_data_figure2 <- all_data_figure2 %>%
  group_by(hh_water, ecolimpn_source_cat) %>%
  summarise(count = n()) %>%
  mutate(percent = count / sum(count) * 100)

all_data_figure2 <- all_data_figure2 %>%
  mutate(label = case_when(
    hh_water == "Access" & ecolimpn_source_cat == "<1" ~ "+3.44",
    hh_water == "Access" & ecolimpn_source_cat == "1-9" ~ "-3.08",
    hh_water == "Access" & ecolimpn_source_cat == "10-99" ~ "-1.80",
    hh_water == "Access" & ecolimpn_source_cat == "100-999" ~ "+0.52",
    hh_water == "Access" & ecolimpn_source_cat == ">1000" ~ "+0.92",
    TRUE ~ NA_character_
  ))

figure2b <- ggplot(all_data_figure2, aes(x = ecolimpn_source_cat, y = percent, fill = hh_water)) +
  geom_bar(position = "dodge", stat = "identity") +
  labs(
    title = "B",
    x = expression(italic(E.~coli)~contamination~levels~`in`~source~water~(MPN/`100`~mL)),
    y = "Percent Frequency",
    fill = "Direct Connection"
  ) +
  theme_minimal() +
  geom_text(aes(label = label), position = position_dodge(width = 0.9), vjust = -0.5)+
 theme(
    plot.title = element_text(size = 20),        # Adjust the plot title size
    axis.title.x = element_text(size = 13),      # Adjust the x-axis title size
    axis.title.y = element_text(size = 16),      # Adjust the y-axis title size
    axis.text.x = element_text(size = 12),       # Adjust the x-axis text size
    axis.text.y = element_text(size = 12),       # Adjust the y-axis text size
    legend.title = element_text(size = 16),      # Adjust the legend title size
    legend.text = element_text(size = 14)        # Adjust the legend text size
  )


figure2 <- grid.arrange(figure2a, figure2b, ncol= 1)
ggsave("plots/Figure 2. E. coli category by intervention status.png", figure2, width = 8, height = 12)

# Cleanup
rm(all_data_figure2, figure2a, figure2b, all_data_figure2_network)
```

## Multivariate association between intervention with water quality and access 
Using intent-to-treat (ITT)- like analysis which means that we will compare outcomes based on whether the participant lives in the intervention neighborhood regardless of their use of the intervention. We use the variable 'code' to indicate the study cluster. We account for matching by including the matching strata in each model. 

**Outcome Variables**: prevalence of detectable E. coli in source water [primary], prevalence of detectable E. coli in stored water, prevalence of at least *basic* water source, prevalence of water that is accessible on premises, prevalence of households with sufficient quantities of drinking water when needed, prevalence of household with HWISE score of >=12 (water_insecure), prevalence of always being satisfied with 1) service, 2) affordability, 3) availability, 4) pressure, 5) appearance, 6) smell, prevalence of WHO-recommended free chlorine levels

```{r format data for models}
# Arrange by code 
all_data <- all_data %>%
  arrange(code)

# Make sure visit and final_match_strata_3 are factor
all_data$visit <- as.factor(all_data$visit)
all_data$final_match_strata_3 <- as.factor(all_data$final_match_strata_3)
```

### Supplemental Table 2. Impact of intervention on water quality and acccess (12 months)
```{r supp table 2 models, results = 'hide', message = FALSE, warning = FALSE}
# Subset to visit 5 and no crossover households
all_data_network_visit5 <- all_data %>%
  filter(visit == 5 & crossover == 0)

# Make sure dataset is ordered by code for GEE models
all_data_network_visit5 <- all_data_network_visit5 %>%
  arrange(code)

# Run models
# Prev. of E. coli in source water 
## Unadjusted 
model_formula <- ecoli_bin_source ~ arm 
extract <- extract_summary_pois(model_formula, "E. coli in source water", all_data_network_visit5)
result_prevecoli_unadjusted <- extract$result_df

## Adjusted
model_formula <- ecoli_bin_source ~ arm + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri
extract <- extract_summary_pois(model_formula, "E. coli in source water", all_data_network_visit5)
result_prevecoli <- extract$result_df

# Prev. of E. coli in stored water
## Unadjusted 
model_formula <- ecoli_bin_stored ~ arm 
extract <- extract_summary_pois(model_formula, "E. coli in stored water", all_data_network_visit5)
result_prevecoli_stored_unadjusted <- extract$result_df

## Adjusted- prev ecoli in stored water
model_formula <- ecoli_bin_stored ~ arm + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh  + fixed_emp_pri 
extract <- extract_summary_pois(model_formula, "E. coli in stored water", all_data_network_visit5)
result_prevecoli_stored <- extract$result_df

# Prev. of access to at least basic water source - MODEL DID NOT CONVERGE with log binomial
## Unadjusted
model_formula <- basic_water ~ arm 
extract <- extract_summary_pois(model_formula, "Access to at least basic water source", all_data_network_visit5)
result_basicwater_unadjusted <- extract$result_df

## Adjusted
model_formula <- basic_water ~ arm + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri
extract <- extract_summary_pois(model_formula, "Access to at least basic water source", all_data_network_visit5)
result_basicwater <- extract$result_df

# Prev. of access to at water on premises - did not converge with log binomial
## Unadjusted
model_formula <- onpremises ~ arm 
extract <- extract_summary_pois(model_formula, "Access to water on the premises", all_data_network_visit5)
result_onpremises_unadjusted <- extract$result_df

## Adjusted
model_formula <- onpremises ~ arm + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri
extract <- extract_summary_pois(model_formula, "Access to water on the premises", all_data_network_visit5)
result_onpremises <- extract$result_df

# Prev. of HH with sufficient quantities of water when needed - did not run with log binomial
## Unadjusted
model_formula <- sufficient ~ arm
extract <- extract_summary_pois(model_formula, "Sufficient quantities of water when needed", all_data_network_visit5)
result_sufficient_unadjusted <- extract$result_df

## Adjusted
model_formula <- sufficient ~ arm + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri
extract <- extract_summary_pois(model_formula, "Sufficient quantities of water when needed", all_data_network_visit5)
result_sufficient <- extract$result_df

# Prev. of water insecurity
##Unadjusted 
model_formula <- HWISE_insecure_new ~ arm 
extract <- extract_summary_pois(model_formula, "Water insecure", all_data_network_visit5)
result_hwise_unadjusted <- extract$result_df

## Adjusted
model_formula <- HWISE_insecure_new ~ arm + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri
extract <- extract_summary_pois(model_formula, "Water secure", all_data_network_visit5)
result_hwise <- extract$result_df

# Prev. of HH always being satisfied with water service 
## Unadjusted
model_formula <- always_sat_service ~ arm
extract <- extract_summary_pois(model_formula, "Satisfied with water service",all_data_network_visit5)
result_sat_service_unadjusted <- extract$result_df

## Adjusted
model_formula <- always_sat_service ~ arm + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri
extract<- extract_summary_pois(model_formula, "Satisfied with water service", all_data_network_visit5)
result_sat_service <- extract$result_df

#Prev. of HH always being satisfied with water affordability
## Unadjusted
model_formula <- always_sat_afford ~ arm
extract <- extract_summary_pois(model_formula, "Satisfied with water affordability", all_data_network_visit5)
result_sat_afford_unadjusted <- extract$result_df

## Adjusted
model_formula <- always_sat_afford ~ arm + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri
extract <- extract_summary_pois(model_formula, "Satisfied with water affordability", all_data_network_visit5)
result_sat_afford <- extract$result_df

# Prev. of HH always being satisfied with water availability
## Unadjusted
model_formula <- always_sat_avail ~ arm 
extract <- extract_summary_pois(model_formula, "Satisfied with water availability", all_data_network_visit5)
result_sat_avail_unadjusted <- extract$result_df

## Adjusted
model_formula <- always_sat_avail ~ arm + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri
extract <- extract_summary_pois(model_formula, "Satisfied with water availability", all_data_network_visit5)
result_sat_avail <- extract$result_df

# Prev. of HH always being satisfied with water pressure
## Unadjusted
model_formula <- always_sat_pressure ~ arm 
extract <- extract_summary_pois(model_formula, "Satisfied with water pressure", all_data_network_visit5)
result_sat_pressure_unadjusted <- extract$result_df

## Adjusted
model_formula <- always_sat_pressure ~ arm + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri
extract<- extract_summary_pois(model_formula, "Satisfied with water pressure", all_data_network_visit5)
result_sat_pressure <- extract$result_df

# Prev. of HH always being satisfied with water color and appearance
## Unadjusted
model_formula <- always_sat_appear ~ arm 
extract <- extract_summary(model_formula, "Satisfied with water color and appearance", all_data_network_visit5)
result_sat_appear_unadjusted <- extract$result_df

## Adjusted
model_formula <- always_sat_appear ~ arm + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri
extract <- extract_summary(model_formula, "Satisfied with water color and appearance", all_data_network_visit5)
result_sat_appear <- extract$result_df

# Prev. of HH always being satisfied with water taste and smell
## Unadjusted
model_formula <- always_sat_taste ~ arm 
extract <- extract_summary_pois(model_formula, "Satisfied with water taste and smell", all_data_network_visit5)
result_sat_taste_unadjusted <- extract$result_df

## Adjusted
model_formula <- always_sat_taste ~ arm + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri
extract <- extract_summary_pois(model_formula, "Satisfied with water taste and smell", all_data_network_visit5)
result_sat_taste <- extract$result_df

## Binary water use (respondent)  - did not converge with log binomial
## Unadjusted
model_formula <- use_respond_bin ~ arm 
extract <- extract_summary_pois(model_formula, ">= 80 L/day of water use (respondent)", all_data_network_visit5)
result_use_respond_unadjusted <- extract$result_df

## Adjusted
model_formula <- use_respond_bin ~ arm + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri
extract <- extract_summary_pois(model_formula, ">= 80 L/day of water use (respondent)", all_data_network_visit5)
result_use_respond <- extract$result_df

## WHO free chlorine levels in source water 
## Unadjusted
model_formula <- free_chlor_WHO ~ arm 
extract <- extract_summary_pois(model_formula, "WHO-recommended free chlorine in source water", all_data_network_visit5)
result_free_chlor_unadjusted <- extract$result_df

## Adjusted
model_formula <- free_chlor_WHO ~ arm + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri
extract <- extract_summary_pois(model_formula, "WHO-recommended free chlorine in source water", all_data_network_visit5)
result_free_chlor <- extract$result_df

# Concatenate all results into one dataframe
supp_table2_adjusted <- rbind(result_prevecoli, result_prevecoli_stored, result_hwise, result_basicwater, result_onpremises, result_sufficient, result_sat_service, result_sat_afford, result_sat_avail, result_sat_pressure, result_sat_appear, result_sat_taste, result_use_respond, result_free_chlor)

supp_table2_unadjusted <- rbind(result_prevecoli_unadjusted, result_prevecoli_stored_unadjusted, result_hwise_unadjusted, result_basicwater_unadjusted, result_onpremises_unadjusted, result_sufficient_unadjusted, result_sat_service_unadjusted, result_sat_afford_unadjusted, result_sat_avail_unadjusted, result_sat_pressure_unadjusted, result_sat_appear_unadjusted, result_sat_taste_unadjusted, result_use_respond_unadjusted, result_free_chlor_unadjusted)

# Write table output to CSV 
write.csv(supp_table2_adjusted, "results/Supplemental Table 2b. Multivariate association between neighborhood-intervention and water quality and access (12 months).csv")
write.csv(supp_table2_unadjusted, "results/Supplemental Table 2a. Unadjusted association between neighborhood-intervention and water quality and access (12 months).csv")

# Cleanup
rm(result_basicwater, result_basicwater_unadjusted, result_free_chlor, result_free_chlor_unadjusted, result_hwise, result_hwise_unadjusted, result_onpremises, result_onpremises_unadjusted, result_prevecoli, result_prevecoli_unadjusted, result_prevecoli_stored, result_prevecoli_stored_unadjusted, result_sat_afford, result_sat_afford_unadjusted, result_sat_appear, result_sat_appear_unadjusted, result_sat_avail, result_sat_avail_unadjusted, result_sat_pressure, result_sat_pressure_unadjusted, result_sat_service, result_sat_service_unadjusted, result_sat_taste, result_sat_taste_unadjusted, result_sufficient, result_sufficient_unadjusted, result_use_respond, result_use_respond_unadjusted, extract)

```

```{r supp table 2 output, echo = FALSE}
knitr::kable(supp_table2_unadjusted, caption = "Supplemental Table 2. Unadjusted impact of the intervention on water quality and access (12 months)")
knitr::kable(supp_table2_adjusted, caption = "Supplemental Table 2. Adjusted impact of the intervention on water quality and access (12 months)")
```

### Table 2 - primary variables + network effect (all timepoints)
General Model Structure: 
Outcome: water quality/access variable
Predictor: arm (neighborhood intervention status)
Covariates: HH sanitation, HH SES [high_poverty], education of primary caregiver, matching strata & months in HH
Effect modifiers: visit

```{r model construction table 2, results = 'hide', message = FALSE, warning = FALSE}
# Filter out crossover vars
all_data_network <- all_data %>%
  filter(crossover == 0)

all_data_network <- all_data_network %>%
  arrange(code)

# Fidelity model - all timepoints
model_formula <- hh_water ~ arm + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri
extract <- extract_summary_pois(model_formula, "HH Water", all_data_network)
result_hhwater <- extract$result_df

# Fidelity model - 12-months
model_formula <- hh_water ~ arm + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri
extract <- extract_summary_pois(model_formula, "HH Water", all_data_network_visit5)
result_hhwater <- extract$result_df

# Prev. E. coli in source water 
## Unadjusted 
model_formula <- ecoli_bin_source ~ arm 
extract <- extract_summary_pois(model_formula, "E. coli in source water", all_data_network)
result_prevecoli_unadjusted <- extract$result_df

## Adjusted
model_formula <- ecoli_bin_source ~ arm + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri
extract <- extract_summary_pois(model_formula, "E. coli in source water", all_data_network)
result_prevecoli <- extract$result_df

# Prev. E. coli in stored water 
## Unadjusted 
model_formula <- ecoli_bin_stored ~ arm 
extract <- extract_summary(model_formula, "E. coli in stored water", all_data_network)
result_prevecoli_stored_unadjusted <- extract$result_df

## Adjusted
model_formula <- ecoli_bin_stored ~ arm + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh  + fixed_emp_pri 
extract <- extract_summary(model_formula, "E. coli in stored water", all_data_network)
result_prevecoli_stored <- extract$result_df

# Prev. of access to at least basic water source - MODEL DID NOT CONVERGE with log binomial
## Unadjusted
model_formula <- basic_water ~ arm 
extract <- extract_summary_pois(model_formula, "Access to at least basic water source", all_data_network)
result_basicwater_unadjusted <- extract$result_df

## Adjusted
model_formula <- basic_water ~ arm + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri 
extract <- extract_summary_pois(model_formula, "Access to at least basic water source", all_data_network)
result_basicwater <- extract$result_df

# Prev. of access to at water on premises - did not converge with log binomial
## Unadjusted
model_formula <- onpremises ~ arm 
extract <- extract_summary_pois(model_formula, "Access to water on the premises", all_data_network)
result_onpremises_unadjusted <- extract$result_df

## Adjusted
model_formula <- onpremises ~ arm + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri
extract <- extract_summary_pois(model_formula, "Access to water on the premises", all_data_network)
result_onpremises <- extract$result_df

# Prev. of HH with sufficient quantities of water when needed - did not run with log binomial
## Unadjusted
model_formula <- sufficient ~ arm
extract <- extract_summary_pois(model_formula, "Sufficient quantities of water when needed", all_data_network)
result_sufficient_unadjusted <- extract$result_df

## Adjusted
model_formula <- sufficient ~ arm + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri
extract <- extract_summary_pois(model_formula, "Sufficient quantities of water when needed", all_data_network)
result_sufficient <- extract$result_df

# Prev. of HH with HWISE score >= 12
## Unadjusted
model_formula <- HWISE_insecure_new ~ arm 
extract <- extract_summary_pois(model_formula, "Water insecure", all_data_network)
result_hwise_unadjusted <- extract$result_df

## Adjusted
model_formula <- HWISE_insecure_new ~ arm + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri 
extract <- extract_summary_pois(model_formula, "Water insecure", all_data_network)
result_hwise <- extract$result_df

# Prev. of HH always being satisfied with water service 
## Unadjusted
model_formula <- always_sat_service ~ arm
extract <- extract_summary_pois(model_formula, "Satisfied with water service", all_data_network)
result_sat_service_unadjusted <- extract$result_df

## Adjusted
model_formula <- always_sat_service ~ arm + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri 
extract <- extract_summary_pois(model_formula, "Satisfied with water service", all_data_network)
result_sat_service <- extract$result_df


#Prev. of HH always being satisfied with water affordability
## Unadjusted
model_formula <- always_sat_afford ~ arm
extract <- extract_summary_pois(model_formula, "Satisfied with water affordability", all_data_network)
result_sat_afford_unadjusted <- extract$result_df

## Adjusted
model_formula <- always_sat_afford ~ arm + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri 
extract <- extract_summary_pois(model_formula, "Satisfied with water affordability", all_data_network)
result_sat_afford <- extract$result_df

# Prev. of HH always being satisfied with water availability
## Unadjusted
model_formula <- always_sat_avail ~ arm 
extract <- extract_summary(model_formula, "Satisfied with water availability", all_data_network)
result_sat_avail_unadjusted <- extract$result_df

## Adjusted
model_formula <- always_sat_avail ~ arm + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri 
extract <- extract_summary(model_formula, "Satisfied with water availability", all_data_network)
result_sat_avail <- extract$result_df

# Prev. of HH always being satisfied with water pressure
## Unadjusted
model_formula <- always_sat_pressure ~ arm 
extract <- extract_summary(model_formula, "Satisfied with water pressure", all_data_network)
result_sat_pressure_unadjusted <- extract$result_df

## Adjusted
model_formula <- always_sat_pressure ~ arm + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri 
extract <- extract_summary(model_formula, "Satisfied with water pressure", all_data_network)
result_sat_pressure <- extract$result_df

# Prev. of HH always being satisfied with water color and appearance
## Unadjusted
model_formula <- always_sat_appear ~ arm 
extract <- extract_summary(model_formula, "Satisfied with water color and appearance", all_data_network)
result_sat_appear_unadjusted <- extract$result_df

## Adjusted
model_formula <- always_sat_appear ~ arm + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri 
extract <- extract_summary(model_formula, "Satisfied with water color and appearance", all_data_network)
result_sat_appear <- extract$result_df

# Prev. of HH always being satisfied with water taste and smell
## Unadjusted
model_formula <- always_sat_taste ~ arm 
extract <- extract_summary(model_formula, "Satisfied with water taste and smell", all_data_network)
result_sat_taste_unadjusted <- extract$result_df

## Adjusted
model_formula <- always_sat_taste ~ arm + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri 
extract<- extract_summary(model_formula, "Satisfied with water taste and smell", all_data_network)
result_sat_taste <- extract$result_df

## Binary water use (respondent)  - did not converge with log binomial
## Unadjusted
model_formula <- use_respond_bin ~ arm 
extract<- extract_summary_pois(model_formula, ">= 80 L/day of water use (respondent)", all_data_network)
result_use_respond_unadjusted <- extract$result_df

## Adjusted
model_formula <- use_respond_bin ~ arm + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri 
extract <- extract_summary_pois(model_formula, ">= 80 L/day of water use (respondent)", all_data_network)
result_use_respond <- extract$result_df

## WHO free-chlorine
## Unadjusted
model_formula <- free_chlor_WHO ~ arm 
extract <- extract_summary_pois(model_formula, "Free chlorine in source water", all_data_network)
result_free_chlor_unadjusted <- extract$result_df

## Adjusted
model_formula <- free_chlor_WHO ~ arm + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri 
extract <- extract_summary_pois(model_formula, "Free chlorine in source water", all_data_network)
result_free_chlor <- extract$result_df

# Concatenate all results into one dataframe
table2_adjusted <- rbind(result_prevecoli, result_prevecoli_stored, result_hwise, result_basicwater, result_onpremises, result_sufficient, result_sat_service, result_sat_afford, result_sat_avail, result_sat_pressure, result_sat_appear, result_sat_taste, result_use_respond, result_free_chlor)

table2_unadjusted <- rbind(result_prevecoli_unadjusted, result_prevecoli_stored_unadjusted, result_hwise_unadjusted, result_basicwater_unadjusted, result_onpremises_unadjusted, result_sufficient_unadjusted, result_sat_service_unadjusted, result_sat_afford_unadjusted, result_sat_avail_unadjusted, result_sat_pressure_unadjusted, result_sat_appear_unadjusted, result_sat_taste_unadjusted, result_use_respond_unadjusted, result_free_chlor_unadjusted)


# Write table output to CSV 
write.csv(table2_adjusted, "results/Table 2b. Multivariate association between neighborhood-intervention and water quality and access.csv")
write.csv(table2_unadjusted, "results/Table 2a. Unadjusted association between neighborhood-intervention and water quality and access.csv")

# Cleanup
rm(result_basicwater, result_basicwater_unadjusted, result_free_chlor, result_free_chlor_unadjusted, result_hwise, result_hwise_unadjusted, result_onpremises, result_onpremises_unadjusted, result_prevecoli, result_prevecoli_unadjusted, result_prevecoli_stored, result_prevecoli_stored_unadjusted, result_sat_afford, result_sat_afford_unadjusted, result_sat_appear, result_sat_appear_unadjusted, result_sat_avail, result_sat_avail_unadjusted, result_sat_pressure, result_sat_pressure_unadjusted, result_sat_service, result_sat_service_unadjusted, result_sat_taste, result_sat_taste_unadjusted, result_sufficient, result_sufficient_unadjusted, result_use_respond, result_use_respond_unadjusted, result_hhwater, extract, model_formula)
```

```{r table 2 output, echo = FALSE}
knitr::kable(table2_unadjusted, caption = "Table 2. Unadjusted impact of the intervention on water quality and access (all timepoints)")
knitr::kable(table2_adjusted, caption = "Table 2. Adjusted impact of the intervention on water quality and access (all timepoints)")
```

#### Forest Plot (Intervention)
Plots used in presentations and not the version included in the final manuscript. 
```{r plot presentation plot 1, echo = FALSE}
# Forest Plot 
## Set order of variables on Forest Plot
custom_order <- c("Free chlorine in source water",">= 80 L/day of water use (respondent)", "Satisfied with water taste and smell", "Satisfied with water color and appearance", "Satisfied with water pressure", "Satisfied with water availability", "Satisfied with water affordability", "Satisfied with water service", "Sufficient quantities of water when needed", "Access to water on the premises", "Access to at least basic water source", "Water insecure", "E. coli in stored water", "E. coli in source water")

table2_adjusted$Outcome_Variable <- factor(table2_adjusted$Outcome_Variable, levels = custom_order)

# Set position width between Outcome variables on plot  
  dodge <- position_dodge(width = 0.25)
  
 presentation_plot1 <- ggplot(table2_adjusted, aes(x = Prevalence_Ratio, y = Outcome_Variable)) +
  geom_point(color = "dodgerblue2", position = dodge) +  # Color applied directly, not inside aes()
  geom_errorbarh(aes(xmin = CI_Lower, xmax = CI_Upper), color = "dodgerblue2", height = 0, position = dodge) +  # Color applied directly
  geom_vline(xintercept = 1, linetype = "dashed", color = "black") +  # Dashed line at x = 1
  scale_y_discrete(labels = function(y) str_wrap(y, width = 35)) +
  labs(
    x = "Prevalence Ratio", 
    y = "Outcome Variable"
  ) + 
  theme_minimal() +
  theme(
    legend.title = element_blank(),
    axis.text.y = element_text(size = 10),
    axis.title.y = element_text(size = 12),
    axis.title.x = element_text(size = 12),
    plot.title = element_text(size = 14, face = "bold")
  )

# Add horizontal lines between levels of Outcome_Variable
y_levels <- levels(factor(table2_adjusted$Outcome_Variable))
y_positions <- seq_along(y_levels) - 0.5
for (y in y_positions) {
  presentation_plot1 <- presentation_plot1 + geom_hline(yintercept = y, color = "darkgrey", linetype = "solid", linewidth = 0.5)
}

presentation_plot1

# Save Plot
ggsave(presentation_plot1, file = "plots/Presentation Plot 1. Multivariate network effect on water quality and access.png", width = 8, height = 6, units = "in", dpi = 300)

# Cleanup 
rm(dodge)
```

## Supplemental Table 3 - primary variables + direct HH connection 
```{r supp table 3, results = 'hide', message = FALSE, warning = FALSE}
# Subset to visit 5 and no crossover households
all_data_visit5 <- all_data %>%
  filter(visit == 5)

# Make sure dataset is ordered by code for GEE models
all_data_visit5 <- all_data_visit5 %>%
  arrange(code)

# Prev. of No E. coli in source water 
## Unadjusted
model_formula <- ecoli_bin_source ~ hh_water
extract <- extract_summary_pois(model_formula, "E. coli in source water", all_data_visit5)
result_prevecoli_unadjusted <- extract$result_df

## Adjusted
model_formula <- ecoli_bin_source ~ hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + months_in_hh + flooding_HH_yard + arm + final_match_strata_3
extract <- extract_summary_pois(model_formula, "E. coli in source water", all_data_visit5)
result_prevecoli <- extract$result_df

# Prev. of No E. coli in stored water 
## Unadjusted
model_formula <- ecoli_bin_stored ~ hh_water
extract <- extract_summary_pois(model_formula, "E. coli in stored water", all_data_visit5)
result_prevecoli_stored_unadjusted <- extract$result_df

## Adjusted
model_formula <- ecoli_bin_stored ~ hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + months_in_hh + flooding_HH_yard + arm + final_match_strata_3
extract <- extract_summary_pois(model_formula, "E. coli in stored water", all_data_visit5)
result_prevecoli_stored <- extract$result_df

# Prev. of access to at least basic water source - did not converge
## Unadjusted
model_formula <- basic_water ~ hh_water 
extract <- extract_summary_pois(model_formula, "Access to at least basic water source", all_data_visit5)
result_basicwater_unadjusted <- extract$result_df

## Adjusted
model_formula <- basic_water ~ hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + months_in_hh + flooding_HH_yard + arm + final_match_strata_3
extract <- extract_summary_pois(model_formula, "Access to at least basic water source", all_data_visit5)
result_basicwater <- extract$result_df

# Prev. of access to at water on premises- did not converge
## Unadjusted
model_formula <- onpremises ~ hh_water 
extract <- extract_summary_pois(model_formula, "Access to water on the premises", all_data_visit5)
result_onpremises_unadjusted <- extract$result_df
  
## Adjusted
model_formula <- onpremises ~ hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + months_in_hh + flooding_HH_yard + arm + final_match_strata_3
extract <- extract_summary_pois(model_formula, "Access to water on the premises", all_data_visit5)
result_onpremises <- extract$result_df

# Prev. of HH with sufficient quantities of water when needed - did not converge
## Unadjusted
model_formula <- sufficient ~ hh_water
extract <- extract_summary_pois(model_formula, "Sufficient quantities of water when needed", all_data_visit5)
result_sufficient_unadjusted <- extract$result_df
  
## Adjusted
model_formula <- sufficient ~ hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + months_in_hh + flooding_HH_yard + arm + final_match_strata_3
extract <- extract_summary_pois(model_formula, "Sufficient quantities of water when needed", all_data_visit5)
result_sufficient <- extract$result_df 

# Prev. of HH with HWISE score >=12 
## Unadjusted
model_formula <- HWISE_insecure_new ~ hh_water
extract <- extract_summary_pois(model_formula, "Water insecure", all_data_visit5)
result_hwise_unadjusted <- extract$result_df

## Adjusted
model_formula <- HWISE_insecure_new ~ hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + months_in_hh + flooding_HH_yard + arm + final_match_strata_3
extract <- extract_summary_pois(model_formula, "Water insecure", all_data_visit5)
result_hwise <- extract$result_df

# Prev. of HH always being satisfied with water service 
## Unadjusted
model_formula <- always_sat_service ~ hh_water
extract <- extract_summary_pois(model_formula, "Satisfied with water service", all_data_visit5)
result_sat_service_unadjusted <- extract$result_df

## Adjusted 
model_formula <- always_sat_service ~ hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + months_in_hh + flooding_HH_yard + arm + final_match_strata_3
extract <- extract_summary_pois(model_formula, "Satisfied with water service", all_data_visit5)
result_sat_service <- extract$result_df

# Prev. of HH always being satisfied with water affordability - did not converge
## Unadjusted
model_formula <- always_sat_afford ~ hh_water 
extract <- extract_summary_pois(model_formula, "Satisfied with water affordability", all_data_visit5)
result_sat_afford_unadjusted <- extract$result_df
  
## Adjusted
model_formula <- always_sat_afford ~ hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + months_in_hh + flooding_HH_yard + arm + final_match_strata_3
extract <- extract_summary_pois(model_formula, "Satisfied with water affordability", all_data_visit5)
result_sat_afford <- extract$result_df

# Prev. of HH always being satisfied with water availability - did not converge
## Unadjusted
model_formula <- always_sat_avail ~ hh_water 
extract <- extract_summary_pois(model_formula, "Satisfied with water availability", all_data_visit5)
result_sat_avail_unadjusted <- extract$result_df

## Adjusted
model_formula <- always_sat_avail ~ hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + months_in_hh + flooding_HH_yard + arm + final_match_strata_3
extract <- extract_summary_pois(model_formula, "Satisfied with water availability", all_data_visit5)
result_sat_avail <- extract$result_df

# Prev. of HH always being satisfied with water pressure- did not converge
## Unadjusted
model_formula <- always_sat_pressure ~ hh_water
extract <- extract_summary_pois(model_formula, "Satisfied with water pressure", all_data_visit5)
result_sat_pressure_unadjusted <- extract$result_df

## Adjusted
model_formula <- always_sat_pressure ~ hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + months_in_hh + flooding_HH_yard + arm + final_match_strata_3
extract <- extract_summary_pois(model_formula, "Satisfied with water pressure", all_data_visit5)
result_sat_pressure <- extract$result_df
  
# Prev. of HH always being satisfied with water color and appearance
## Unadjusted
model_formula <- always_sat_appear ~ hh_water 
extract <- extract_summary(model_formula, "Satisfied with water color and appearance", all_data_visit5)
result_sat_appear_unadjusted <- extract$result_df

## Adjusted
model_formula <- always_sat_appear ~ hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + months_in_hh + flooding_HH_yard + arm + final_match_strata_3
extract <- extract_summary(model_formula, "Satisfied with water color and appearance", all_data_visit5)
result_sat_appear <- extract$result_df

# Prev. of HH always being satisfied with water taste and smell - did not converge
## Unadjusted
model_formula <- always_sat_taste ~ hh_water
extract <- extract_summary_pois(model_formula, "Satisfied with water taste and smell", all_data_visit5)
result_sat_taste_unadjusted <- extract$result_df

## Adjusted
model_formula <- always_sat_taste ~ hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + months_in_hh + flooding_HH_yard + arm + final_match_strata_3
extract <- extract_summary_pois(model_formula, "Satisfied with water taste and smell", all_data_visit5)
result_sat_taste <- extract$result_df

# Binary water use (respondent)  - did not converge
## Unadjusted
model_formula <- use_respond_bin ~ hh_water
extract <- extract_summary_pois(model_formula, ">= 80 L/day of water use (respondent)", all_data_visit5)
result_use_respond_unadjusted <- extract$result_df

## Adjusted
model_formula <- use_respond_bin ~ hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + months_in_hh + flooding_HH_yard + arm + final_match_strata_3
extract <- extract_summary_pois(model_formula, ">= 80 L/day of water use (respondent)", all_data_visit5)
result_use_respond <- extract$result_df    

# Free chlorine
## Unadjusted
model_formula <- free_chlor_WHO ~ hh_water
extract <- extract_summary_pois(model_formula, "Free chlorine in source water", all_data_visit5)
result_free_chlor_unadjusted <- extract$result_df

## Adjusted
model_formula <- free_chlor_WHO ~ hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + months_in_hh + flooding_HH_yard + arm + final_match_strata_3
extract <- extract_summary_pois(model_formula, "Free chlorine in source water", all_data_visit5)
result_free_chlor <- extract$result_df   

# Concatenate all results into one dataframe
supp_table3_adjusted <- rbind(result_prevecoli, result_prevecoli_stored, result_hwise, result_basicwater, result_onpremises, result_sufficient, result_sat_service, result_sat_afford, result_sat_avail, result_sat_pressure, result_sat_appear, result_sat_taste, result_use_respond, result_free_chlor)

supp_table3_unadjusted <- rbind(result_prevecoli_unadjusted, result_prevecoli_stored_unadjusted, result_hwise_unadjusted, result_basicwater_unadjusted, result_onpremises_unadjusted, result_sufficient_unadjusted, result_sat_service_unadjusted, result_sat_afford_unadjusted, result_sat_avail_unadjusted, result_sat_pressure_unadjusted, result_sat_appear_unadjusted, result_sat_taste_unadjusted, result_use_respond_unadjusted, result_free_chlor_unadjusted)

# Write table output to CSV 
write.csv(supp_table3_adjusted, "results/Supplemental Table 3b. Multivariate association between HH-intervention and water quality and access (12 months).csv")
write.csv(supp_table3_unadjusted, "results/Supplemental Table 3a. Unadjusted association between HH-intervention and water quality and access (12 months.csv")

# Cleanup
rm(result_basicwater, result_basicwater_unadjusted, result_free_chlor, result_free_chlor_unadjusted, result_hwise, result_hwise_unadjusted, result_onpremises, result_onpremises_unadjusted, result_prevecoli, result_prevecoli_unadjusted, result_prevecoli_stored, result_prevecoli_stored_unadjusted, result_sat_afford, result_sat_afford_unadjusted, result_sat_appear, result_sat_appear_unadjusted, result_sat_avail, result_sat_avail_unadjusted, result_sat_pressure, result_sat_pressure_unadjusted, result_sat_service, result_sat_service_unadjusted, result_sat_taste, result_sat_taste_unadjusted, result_sufficient, result_sufficient_unadjusted, result_use_respond, result_use_respond_unadjusted, extract, model_formula)

```

```{r supp table 3 output, echo = FALSE}
knitr::kable(supp_table3_unadjusted, caption = "Supplemental Table 3. Unadjusted association between direct connection and water quality and access (12 months)")
knitr::kable(supp_table3_adjusted, caption = "Supplemental Table 3. Adjusted association between direct connection and water quality and access (12 months)")
```

### Table 3 - primary variables + direct HH connection (all timepoints)

#### Model Construction (Table 3)

General Model Structure: 
Outcome: prev. source water E. coli
Predictor: hh_water
Covariates: HH sanitation, HH SES [high_poverty], fixed employment of primary wage earner, education of primary caregiver, flooding in household or yard, months in HH, neighborhood intervention status, and matching strata

```{r model construction table 3, results = 'hide', message = FALSE, warning = FALSE}
# Prev. E. coli in source water - did not converge with log binomial
## Unadjusted
model_formula <- ecoli_bin_source ~ hh_water
extract <- extract_summary_pois(model_formula, "E. coli in source water", all_data)
result_prevecoli_unadjusted <- extract$result_df

## Adjusted
model_formula <- ecoli_bin_source ~ hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + months_in_hh + flooding_HH_yard + arm + final_match_strata_3 
extract <- extract_summary_pois(model_formula, "E. coli in source water", all_data)
result_prevecoli <- extract$result_df

# Prev. E. coli in stored water 
## Unadjusted
model_formula <- ecoli_bin_stored ~ hh_water
extract <- extract_summary(model_formula, "E. coli in stored water", all_data)
result_prevecoli_stored_unadjusted <- extract$result_df

## Adjusted
model_formula <- ecoli_bin_stored ~ hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + months_in_hh + flooding_HH_yard + arm + final_match_strata_3 
extract <- extract_summary(model_formula, "E. coli in stored water", all_data)
result_prevecoli_stored <- extract$result_df

# Prev. of access to at least basic water source - did not converge
## Unadjusted
model_formula <- basic_water ~ hh_water 
extract <- extract_summary_pois(model_formula, "Access to at least basic water source", all_data)
result_basicwater_unadjusted <- extract$result_df

## Adjusted
model_formula <- basic_water ~ hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + months_in_hh + flooding_HH_yard + arm + final_match_strata_3 
extract <- extract_summary_pois(model_formula, "Access to at least basic water source", all_data)
result_basicwater <- extract$result_df

# Prev. of access to at water on premises- did not converge
## Unadjusted
model_formula <- onpremises ~ hh_water 
extract <- extract_summary_pois(model_formula, "Access to water on the premises", all_data)
result_onpremises_unadjusted <- extract$result_df
  
## Adjusted
model_formula <- onpremises ~ hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + months_in_hh + flooding_HH_yard + arm + final_match_strata_3 
extract <- extract_summary_pois(model_formula, "Access to water on the premises", all_data)
result_onpremises <- extract$result_df

# Prev. of HH with sufficient quantities of water when needed - did not converge
## Unadjusted
model_formula <- sufficient ~ hh_water
extract <- extract_summary_pois(model_formula, "Sufficient quantities of water when needed", all_data)
result_sufficient_unadjusted <- extract$result_df
  
## Adjusted
model_formula <- sufficient ~ hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + months_in_hh + flooding_HH_yard + arm + final_match_strata_3 
extract <- extract_summary_pois(model_formula, "Sufficient quantities of water when needed", all_data)
result_sufficient <- extract$result_df 

# Prev. of HH with HWISE score >=12 
## Unadjusted
model_formula <- HWISE_insecure_new ~ hh_water
extract <- extract_summary_pois(model_formula, "Water insecure", all_data)
result_hwise_unadjusted <- extract$result_df

## Adjusted
model_formula <- HWISE_insecure_new ~ hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + months_in_hh + flooding_HH_yard + arm + final_match_strata_3 
extract <- extract_summary_pois(model_formula, "Water insecure", all_data)
result_hwise <- extract$result_df

# Prev. of HH always being satisfied with water service 
## Unadjusted
model_formula <- always_sat_service ~ hh_water
extract <- extract_summary_pois(model_formula, "Satisfied with water service", all_data)
result_sat_service_unadjusted <- extract$result_df

## Adjusted 
model_formula <- always_sat_service ~ hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + months_in_hh + flooding_HH_yard + arm + final_match_strata_3
extract <- extract_summary_pois(model_formula, "Satisfied with water service", all_data)
result_sat_service <- extract$result_df

# Prev. of HH always being satisfied with water affordability - did not converge
## Unadjusted
model_formula <- always_sat_afford ~ hh_water 
extract <- extract_summary_pois(model_formula, "Satisfied with water affordability", all_data)
result_sat_afford_unadjusted <- extract$result_df
  
## Adjusted
model_formula <- always_sat_afford ~ hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + months_in_hh + flooding_HH_yard + arm + final_match_strata_3
extract <- extract_summary_pois(model_formula, "Satisfied with water affordability", all_data)
result_sat_afford <- extract$result_df

# Prev. of HH always being satisfied with water availability 
## Unadjusted
model_formula <- always_sat_avail ~ hh_water 
extract <- extract_summary(model_formula, "Satisfied with water availability", all_data)
result_sat_avail_unadjusted <- extract$result_df

## Adjusted
model_formula <- always_sat_avail ~ hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + months_in_hh + flooding_HH_yard + arm + final_match_strata_3 
extract <- extract_summary(model_formula, "Satisfied with water availability", all_data)
result_sat_avail <- extract$result_df

# Prev. of HH always being satisfied with water pressure
## Unadjusted
model_formula <- always_sat_pressure ~ hh_water
extract <- extract_summary(model_formula, "Satisfied with water pressure", all_data)
result_sat_pressure_unadjusted <- extract$result_df

## Adjusted
model_formula <- always_sat_pressure ~ hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + months_in_hh + flooding_HH_yard + arm + final_match_strata_3 
extract <- extract_summary(model_formula, "Satisfied with water pressure", all_data)
result_sat_pressure <- extract$result_df

  
# Prev. of HH always being satisfied with water color and appearance
## Unadjusted
model_formula <- always_sat_appear ~ hh_water 
extract <- extract_summary(model_formula, "Satisfied with water color and appearance", all_data)
result_sat_appear_unadjusted <- extract$result_df

## Adjusted
model_formula <- always_sat_appear ~ hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + months_in_hh + flooding_HH_yard + arm + final_match_strata_3
extract<- extract_summary(model_formula, "Satisfied with water color and appearance", all_data)
result_sat_appear <- extract$result_df


# Prev. of HH always being satisfied with water taste and smell 
## Unadjusted
model_formula <- always_sat_taste ~ hh_water
extract <- extract_summary(model_formula, "Satisfied with water taste and smell", all_data)
result_sat_taste_unadjusted <- extract$result_df

## Adjusted
model_formula <- always_sat_taste ~ hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + months_in_hh + flooding_HH_yard + arm + final_match_strata_3 
extract <- extract_summary(model_formula, "Satisfied with water taste and smell", all_data)
result_sat_taste <- extract$result_df

# Binary water use (respondent)  - did not converge
## Unadjusted
model_formula <- use_respond_bin ~ hh_water
extract <- extract_summary_pois(model_formula, ">= 80 L/day of water use (respondent)", all_data)
result_use_respond_unadjusted <- extract$result_df

## Adjusted
model_formula <- use_respond_bin ~ hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + months_in_hh + flooding_HH_yard + arm + final_match_strata_3 + visit
extract <- extract_summary_pois(model_formula, ">= 80 L/day of water use (respondent)", all_data)
result_use_respond <- extract$result_df    

# Free chlorine in source water
## Unadjusted
model_formula <- free_chlor_WHO  ~ hh_water
extract <- extract_summary_pois(model_formula, "Free chlorine in source water", all_data)
result_free_chlor_unadjusted <- extract$result_df

## Adjusted
model_formula <- free_chlor_WHO ~ hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + months_in_hh + flooding_HH_yard + arm + final_match_strata_3 + visit
extract <- extract_summary_pois(model_formula, "Free chlorine in source water", all_data)
result_free_chlor <- extract$result_df    


# Concatenate all results into one dataframe
table3_adjusted <- rbind(result_prevecoli, result_prevecoli_stored, result_hwise, result_basicwater, result_onpremises, result_sufficient, result_sat_service, result_sat_afford, result_sat_avail, result_sat_pressure, result_sat_appear, result_sat_taste,result_use_respond, result_free_chlor)

table3_unadjusted <- rbind(result_prevecoli_unadjusted, result_prevecoli_stored_unadjusted, result_hwise_unadjusted,  result_basicwater_unadjusted, result_onpremises_unadjusted, result_sufficient_unadjusted, result_sat_service_unadjusted, result_sat_afford_unadjusted, result_sat_avail_unadjusted, result_sat_pressure_unadjusted, result_sat_appear_unadjusted, result_sat_taste_unadjusted, result_use_respond_unadjusted, result_free_chlor_unadjusted)

# Write table output to CSV 
write.csv(table3_adjusted, "results/Table 3b. Multivariate association between HH-intervention and water quality and access.csv")
write.csv(table3_unadjusted, "results/Table 3a. Unadjusted association between HH-intervention and water quality and access.csv")

# Cleanup
rm(result_basicwater, result_basicwater_unadjusted, result_free_chlor, result_free_chlor_unadjusted, result_hwise, result_hwise_unadjusted, result_onpremises, result_onpremises_unadjusted, result_prevecoli, result_prevecoli_unadjusted, result_prevecoli_stored, result_prevecoli_stored_unadjusted, result_sat_afford, result_sat_afford_unadjusted, result_sat_appear, result_sat_appear_unadjusted, result_sat_avail, result_sat_avail_unadjusted, result_sat_pressure, result_sat_pressure_unadjusted, result_sat_service, result_sat_service_unadjusted, result_sat_taste, result_sat_taste_unadjusted, result_sufficient, result_sufficient_unadjusted, result_use_respond, result_use_respond_unadjusted, extract, model_formula, extract_summary, extract_summary_pois)

```

```{r table 3 output, echo = FALSE}
knitr::kable(table3_unadjusted, caption = "Table 3. Unadjusted association between direct connection and water quality and access (all timepoints)")
knitr::kable(table3_adjusted, caption = "Table 3. Adjusted association between direct connection and water quality and access (all timepoints)")
```

#### Forest Plot (Intervention & direct connection)
Plots used in presentations and not the version included in the final manuscript. 
```{r presentation plot 2}
# Create indicator variable in each table for network or direct connection effect
table2_adjusted <- table2_adjusted %>%
  mutate(intervention = "Intervention")

table3_adjusted <- table3_adjusted %>%
  mutate(intervention = "Direct connection")

# Combine tables 
table_combined <- rbind(table2_adjusted, table3_adjusted)

# Select colors for plot and dodge position 
  nb.cols <- 3
  family_colors <- c("dodgerblue2", "sienna1")
  
  dodge <- position_dodge(width = 1.0)
  
# Create presentation plot 2 
  presentation_plot2 <- ggplot(table_combined, aes(x = Prevalence_Ratio, y = Outcome_Variable)) +
    geom_point(aes(color = intervention), position = dodge) +  # Add color for different levels of 'intervention' and dodge position
    geom_errorbarh(aes(xmin = CI_Lower, xmax = CI_Upper, color = intervention), height = 0, position = dodge) +  # Confidence intervals with dodge position and matching color
    geom_vline(xintercept = 1, linetype = "dashed", color = "black") +  # Dashed line at x = 1
    scale_y_discrete(labels = function(y) str_wrap(y, width = 35)) +
    scale_color_manual(values = family_colors) +  # Customize colors for 'status'
    labs(
         x = "Prevalence Ratio", 
         y = "Outcome Variable") + 
    theme_minimal() +
    theme(legend.title = element_blank(),
          axis.text.y = element_text(size = 12),
          axis.title.y = element_text(size = 14),
          axis.title.x = element_text(size = 14),
          plot.title = element_text(size = 16, face = "bold"))
  
 # Add horizontal lines between levels of Outcome_Variable
  y_levels <- levels(factor(table_combined$Outcome_Variable))
  y_positions <- seq_along(y_levels) - 0.5
  for (y in y_positions) {
    presentation_plot2 <- presentation_plot2 + geom_hline(yintercept = y, color = "darkgrey", linetype = "solid", linewidth = 0.5)
  }
  
  presentation_plot2

  # Save plot
  ggsave(presentation_plot2, file = "plots/Presentation Plot 2. Intervention and direct connection on water quality and access.png", width = 8, height = 6, units = "in", dpi = 300)
  
# Cleanup 
  rm(dodge, nb.cols, y, y_levels, y_positions, family_colors, table_combined)

```

# Joint effect of intervention and direct connection on water quality and access

We assess the joint effect of the intervention and direct connection on water quality and access. 

```{r factoral intervention formatting}
# Create combined intervention variable 
all_data_network <- all_data_network %>%
  mutate(combined_intervention = ifelse(arm == 0 & hh_water == 0, 0,
                                         ifelse(arm==1 & hh_water == 0, 2,
                                                ifelse(arm== 0 & hh_water == 1, 3, 4))))
# make sure variable is a factor
all_data_network$combined_intervention <- as.factor(all_data_network$combined_intervention)
```

### Supplemental Table 4. Evaluate covariates at enrollment by combined intervention status
```{r supplemental table 4, results = 'hide'}
# Formatting
## Filter to enrollment timepoint
data_visit1 <- all_data_network %>%
  filter(visit == 1)

table(data_visit1$combined_intervention)

# Make variable lists
variables <- c("secondary_complete_bl", "san_basic_obs_bl", "fixed_emp_pri", "human_feces", "animal_feces", "HW_dwell", "season_rainy", "flooding_HH_yard", "high_poverty")

continuous_variables <- c("num_lt5", "num_HH", "months_in_hh", "HFIAS_score")

# Network enrollment table for factor vars
result_list <- frequency_tables_for_vars(data_visit1, variables, "combined_intervention")
combined_results <- bind_rows(result_list)

supp_table4 <- combined_results %>%
  filter(variable_value == 1)

# Repeat for continuous variables 
result_list_continuous <- summary_statistics_for_vars(data_visit1, continuous_variables, "combined_intervention")
supp_table4_continuous <- bind_rows(result_list_continuous)

# Save tables
write.csv(supp_table4, "results/Supplemental Table 4a. Differences in covariates of interest at enrollment by combined intervention status (binary).csv")
write.csv(supp_table4_continuous, "results/Supplemental Table 4b. Differences in covariates of interest at enrollment by combined intervention status (continuous).csv")

# Cleanup
rm(result_list, result_list_continuous, combined_results, continuous_variables, variables, frequency_table, frequency_tables_for_vars, summary_statistics, summary_statistics_for_vars, data_visit1)
```

```{r supplemental table 4 output}
knitr::kable(supp_table4, caption = "Supplemental Table 4. Differences in covariates of interest at enrollment by joint intervention and direct connection status (binary variables)")
knitr::kable(supp_table4, caption = "Supplemental Table 4. Differences in covariates of interest at enrollment by joint intervention and direct connection status (continuous variables)")
```

Covariates included in the model are: num_lt5, num_HH, months_in_HH, high_poverty, san_basic_obs_bl, secondary_complete_bl, fixed_emp_pri, flooding_HH_yard.

### Supplemental Table 5 
#### Rewrite functions to extract each level of intervention 
```{r factoral function}
# Write function to extract appropriate data from each GEE model 
calculate_prev_ratios <- function(model, outcome_variable) {
  # Summary of the model
  model_summary <- summary(model)
  
  # Extract covariance matrix for total effect estimation
  cov_matrix <- model$robust.variance
  
  # Extract coefficients and robust standard errors for the terms of interest
  # Assuming coef_indices are always (2, 3, 20) for arm, hh_water, and interaction
  coef_model <- model_summary$coefficients[c(2, 3, 20), ]
  coef_values <- coef_model[, 1]        # Coefficients for the terms
  robust_se_values <- coef_model[, 4]   # Robust standard errors
  
  # Calculate p-values using robust z-score
  p_values <- 2 * (1 - pnorm(abs(coef_model[, 5])))
  
  # Calculate confidence intervals
  ci_lower <- exp(coef_values - 1.96 * robust_se_values)
  ci_upper <- exp(coef_values + 1.96 * robust_se_values)
  
  # Calculate prevalence ratios
  prevalence_ratios <- exp(coef_values)
  
  ## Total Effect
  ### Coefficient
  B_sum <- sum(coef_values)  # Sum of the coefficients
  
  ### Variance
  var_sum <- cov_matrix["arm", "arm"] + cov_matrix["hh_water", "hh_water"] + cov_matrix["arm:hh_water", "arm:hh_water"] + 
    2 * cov_matrix["arm", "hh_water"] + 2 * cov_matrix["arm", "arm:hh_water"] + 2 * cov_matrix["hh_water", "arm:hh_water"]
  
  ### Robust standard errors
  se_sum <- sqrt(var_sum)
  
  ### Confidence intervals for total effect
  ci_lower_total <- exp(B_sum - 1.96 * se_sum) 
  ci_upper_total <- exp(B_sum + 1.96 * se_sum)
  
  ### Prevalence ratio for total effect
  PR_total <- exp(B_sum)
  
  ### P-value for total effect
  z_total <- B_sum / se_sum
  p_total <- 2 * pnorm(-abs(z_total))
  
  # Create a dataframe for the results
  result_df <- data.frame(
    Outcome_Variable = outcome_variable,
    Coefficient = c("arm", "hh_water", "arm:hh_water", "arm & hh_water (combined)"),
    Prevalence_Ratio = c(prevalence_ratios, PR_total),
    P_Value = c(p_values, p_total),
    CI_Lower = c(ci_lower, ci_lower_total),
    CI_Upper = c(ci_upper, ci_upper_total),
    Robust_se = c(robust_se_values, se_sum)
  )
  
  return(result_df)
}

```

```{r model construction, results = 'hide', message = FALSE, warning = FALSE}
all_data_network <- all_data_network %>%
  arrange(code)

# Prev. of E. coli in source water 
model_formula <- ecoli_bin_source ~ arm + hh_water + arm*hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri + num_lt5 + num_HH + flooding_HH_yard
model <- gee(model_formula, data = all_data_network, id = code, family = poisson(link = "log"), corstr = "independence")
result_ecoli_source <- calculate_prev_ratios(model, "E. coli in source water")

# Prev. of no E. coli in stored water 
model_formula <- ecoli_bin_stored ~ arm + hh_water + arm*hh_water  + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri + num_lt5 + num_HH + flooding_HH_yard
model <- gee(model_formula, data = all_data_network, id = code, family = poisson(link = "log"), corstr = "independence")
result_ecoli_stored <- calculate_prev_ratios(model, "E. coli in stored water")

# Prev. of access to at least basic water source - MODEL DID NOT CONVERGE with log binomial
model_formula <- basic_water ~ arm + hh_water + arm*hh_water  + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri + num_lt5 + num_HH + flooding_HH_yard
model <- gee(model_formula, data = all_data_network, id = code, family = poisson(link = "log"), corstr = "independence")
result_basicwater <- calculate_prev_ratios(model, "Access to at least basic water source")

# Prev. of access to at water on premises - did not converge with log binomial
model_formula <- onpremises ~ arm + hh_water + arm*hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri + num_lt5 + num_HH + flooding_HH_yard
model <- gee(model_formula, data = all_data_network, id = code, family = poisson(link = "log"), corstr = "independence")
result_onpremises <- calculate_prev_ratios(model, "Access to water on the premises")

# Prev. of HH with sufficient quantities of water when needed - did not run with log binomial
model_formula <- sufficient ~ arm + hh_water + arm*hh_water  + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri + num_lt5 + num_HH + flooding_HH_yard 
model <- gee(model_formula, data = all_data_network, id = code, family = poisson(link = "log"), corstr = "independence")
result_sufficient <- calculate_prev_ratios(model, "Sufficient quantities of water when needed")

# Prev. of HH with HWISE score >=12
model_formula <- HWISE_insecure_new ~ arm + hh_water + arm*hh_water  + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri + num_lt5 + num_HH + flooding_HH_yard
model <- gee(model_formula, data = all_data_network, id = code, family = poisson(link = "log"), corstr = "independence")
result_hwise <- calculate_prev_ratios(model, "Water insecure")

# Prev. of HH always being satisfied with water service 
model_formula <- always_sat_service ~ arm + hh_water + arm*hh_water  + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri + num_lt5 + num_HH + flooding_HH_yard
model <- gee(model_formula, data = all_data_network, id = code, family = poisson(link = "log"), corstr = "independence")
result_satservice <- calculate_prev_ratios(model, "Satisfied with water service")

#Prev. of HH always being satisfied with water affordability
model_formula <- always_sat_afford ~ arm + hh_water + arm*hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri + num_lt5 + num_HH + flooding_HH_yard
model <- gee(model_formula, data = all_data_network, id = code, family = poisson(link = "log"), corstr = "independence")
result_satafford <- calculate_prev_ratios(model, "Satisfied with water affordability")

# Prev. of HH always being satisfied with water availability
model_formula <- always_sat_avail ~ arm + hh_water + arm*hh_water  + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri + num_lt5 + num_HH + flooding_HH_yard
model <- gee(model_formula, data = all_data_network, id = code, family = poisson(link = "log"), corstr = "independence")
result_satavail <- calculate_prev_ratios(model, "Satisfied with water availability")

# Prev. of HH always being satisfied with water pressure
model_formula <- always_sat_pressure ~ arm + hh_water + arm*hh_water  + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri + num_lt5 + num_HH + flooding_HH_yard
model <- gee(model_formula, data = all_data_network, id = code, family = poisson(link = "log"), corstr = "independence")
result_satpressure <- calculate_prev_ratios(model, "Satisfied with water pressure")

# Prev. of HH always being satisfied with water color and appearance
## Adjusted
model_formula <- always_sat_appear ~ arm + hh_water + arm*hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri + num_lt5 + num_HH + flooding_HH_yard
model <- gee(model_formula, data = all_data_network, id = code, family = binomial(link = "log"), corstr = "independence")
result_satcolor <- calculate_prev_ratios(model, "Satisfied with water color and appearance")

# Prev. of HH always being satisfied with water taste and smell
model_formula <- always_sat_taste ~ arm + hh_water + arm*hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri + num_lt5 + num_HH + flooding_HH_yard
model <- gee(model_formula, data = all_data_network, id = code, family = binomial(link = "log"), corstr = "independence")
result_sattaste <- calculate_prev_ratios(model, "Satisfied with water taste and smell")

## Binary water use (respondent)  - did not converge with log binomial
model_formula <- use_respond_bin ~ arm + hh_water + arm*hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri + num_lt5 + num_HH + flooding_HH_yard
model <- gee(model_formula, data = all_data_network, id = code, family = poisson(link = "log"), corstr = "independence")
result_userespond <- calculate_prev_ratios(model, ">= 80 L/day of water use (respondent)")

## WHO recommended free chlorine levels
model_formula <- free_chlor_WHO ~ arm + hh_water + arm*hh_water + high_poverty + san_basic_obs_bl + secondary_complete_bl + final_match_strata_3 + months_in_hh + fixed_emp_pri + num_lt5 + num_HH + flooding_HH_yard
model <- gee(model_formula, data = all_data_network, id = code, family = poisson(link = "log"), corstr = "independence")
result_freechlor <- calculate_prev_ratios(model, "Free chlorine in source water")

# Concatenate all results into one dataframe
supp_table5 <- rbind(result_ecoli_source, result_ecoli_stored, result_hwise,  result_basicwater, result_onpremises, result_sufficient, result_satservice, result_satafford, result_satavail, result_satpressure, result_satcolor, result_sattaste, result_userespond, result_freechlor)

# Write table output to CSV 
write.csv(supp_table5, "data-out/Supplemental Table 5. Multivariate association between combined intervention status and water quality and access.csv")

# Cleanup
rm(result_basicwater,result_freechlor,  result_hwise,  result_onpremises,  result_ecoli_source,  result_ecoli_stored,  result_satafford,  result_satcolor,  result_satavail, result_satpressure, result_satservice, result_sattaste, result_sufficient, result_userespond, model_formula, model, calculate_prev_ratios)
```

```{r supp table 5 output, echo = FALSE}
knitr::kable(supp_table5, caption = "Supplemental Table 5. Joint effect of intervention and direct connection on water quality and access (all timepoints)")
```

### Forest plot (Intervention & intervention + direct connection)
```{r figure 3}
# Create indicator variable in each table for network or direct connection effect
table2_adjusted <- table2_adjusted %>%
  mutate(intervention = "Intervention")

# Filter supplemental table 5  for forest plot 
table_5_filtered <- supp_table5 %>%
  filter(Coefficient == "arm & hh_water (combined)")

table_5_filtered <- table_5_filtered %>%
  mutate(intervention = "Intervention and direct connection") %>%
  dplyr::select(-Coefficient)

# Combine tables 
table_combined <- rbind(table2_adjusted, table_5_filtered)

custom_order <- c("Free chlorine in source water", ">= 80 L/day of water use (respondent)", "Satisfied with water taste and smell", "Satisfied with water color and appearance", "Satisfied with water pressure", "Satisfied with water availability", "Satisfied with water affordability", "Satisfied with water service", "Sufficient quantities of water when needed", "Access to water on the premises", "Access to at least basic water source", "Water insecure", "E. coli in stored water", "E. coli in source water")

table_combined$Outcome_Variable <- factor(table_combined$Outcome_Variable, levels = custom_order)

# Pick colors and set dodge position for the plot
  family_colors <- c("sienna1", "dodgerblue2")
  dodge <- position_dodge(width = 1)
  
# Define the custom order for the legend
custom_order <- c( "Intervention and direct connection", "Intervention")
table_combined <- table_combined %>%
  mutate(intervention = factor(intervention, levels = custom_order))

# Create plot with log-transformed axis 
  figure3 <- ggplot(table_combined, aes(x = Prevalence_Ratio, y = Outcome_Variable)) +
  geom_point(aes(color = intervention), position = dodge) +  
  geom_errorbarh(aes(xmin = CI_Lower, xmax = CI_Upper, color = intervention), height = 0, position = dodge) + 
  geom_vline(xintercept = 1, linetype = "dashed", color = "black") +  # Dashed line at x = 1
  scale_x_log10() +  # Log-transform the x-axis
  scale_y_discrete(labels = function(y) str_wrap(y, width = 35)) +
  scale_color_manual(values = family_colors) +  # Customize colors for 'intervention'
  labs(
       x = "Prevalence Ratio (log scale)", 
       y = "Outcome Variable") + 
  theme_minimal() +
  theme(legend.title = element_blank(),
        axis.text.y = element_text(size = 12),
        axis.title.y = element_text(size = 16),
        axis.title.x = element_text(size = 16)) + 
    guides(color = guide_legend(reverse = TRUE))

# Add horizontal lines between levels of Outcome_Variable
y_levels <- levels(factor(table_combined$Outcome_Variable))
y_positions <- seq_along(y_levels) - 0.5
for (y in y_positions) {
  figure3 <- figure3 + geom_hline(yintercept = y, color = "darkgrey", linetype = "solid", linewidth = 0.5)
}

figure3
  
  ggsave(figure3, file = "plots/Figure 3. Intervention and combined intervention on water quality and access.png", width = 10, height = 6, units = "in", dpi = 300)

  # Cleanup
  rm(custom_order, family_colors, y, y_levels, y_positions, table_combined, dodge)
```

# Session Info

```{r Session Info}
sessionInfo()
```

